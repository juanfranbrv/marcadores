---
import { Product } from '../types/product';
---

{/*
  Grid de productos din√°mico con JS puro y Astro
*/}
<div id="product-grid-raindrop"></div>

<script type="module">
const grid = document.getElementById('product-grid-raindrop');

function renderTokenForm() {
  grid.innerHTML = `
    <div class="max-w-md mx-auto mt-10 p-6 bg-white border rounded shadow">
      <h2 class="text-lg font-bold mb-2">Introduce tu Access Token de Raindrop.io</h2>
      <input type="text" id="raindrop-token-input" class="w-full border px-3 py-2 rounded mb-2" placeholder="Access Token" />
      <p class="text-xs text-gray-500 mb-2">Puedes obtenerlo tras autenticarte con OAuth2 o desde la web de Raindrop.io.</p>
    </div>
  `;
  document.getElementById('raindrop-token-input').addEventListener('change', e => {
    localStorage.setItem('raindrop_access_token', e.target.value);
    renderGrid();
  });
}

function raindropToProduct(raindrop) {
  return {
    id: String(raindrop._id),
    title: raindrop.title || raindrop.link,
    description: raindrop.excerpt || '',
    image: raindrop.cover || '/placeholder.png',
    tags: raindrop.tags || [],
    isPaid: false,
    url: raindrop.link,
  };
}

async function renderGrid() {
  const token = localStorage.getItem('raindrop_access_token') || '';
  if (!token) {
    renderTokenForm();
    return;
  }
  grid.innerHTML = '<div class="text-center py-10">Cargando marcadores...</div>';
  try {
    const res = await fetch('/api/raindrop/', { headers: { Authorization: `Bearer ${token}` } });
    const data = await res.json();
    const products = (data.items || []).map(raindropToProduct);
    if (!products.length) {
      grid.innerHTML = '<div class="text-center py-10">No hay marcadores para mostrar.</div>';
      return;
    }
    grid.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        ${products.map(product => `
          <div class="bg-white rounded-lg border overflow-hidden">
            <div class="relative h-48 overflow-hidden">
              <img src="${product.image}" alt="${product.title}" class="object-cover w-full h-full" />
            </div>
            <div class="p-4">
              <h2 class="text-xl font-semibold mb-2">${product.title}</h2>
              <p class="text-gray-600 text-sm mb-4 line-clamp-3">${product.description}</p>
              <div class="flex flex-wrap gap-1 mb-4">
                ${product.tags.map(tag => `<span class="text-xs bg-gray-100 px-2 py-1 rounded-md text-gray-600">#${tag.replace(/\s+/g, '')}</span>`).join('')}
              </div>
              <div class="flex justify-between items-center">
                <div class="flex items-center">
                  ${product.isPaid ? '<span class="text-sm font-medium">Paid</span>' : '<span class="text-sm font-medium">Free</span>'}
                </div>
                <a href="${product.url}" target="_blank" rel="noopener noreferrer" class="text-gray-600 hover:text-gray-900 flex items-center gap-1 text-sm">
                  Visit <svg class="h-3 w-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                </a>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  } catch (e) {
    grid.innerHTML = '<div class="text-red-500 text-center mt-10">Error al cargar los marcadores</div>';
  }
}

renderGrid();
</script>
